<h1><b>Clutter Overflow</b> Challange from PicoCTF</h1>
<h2>Writup</h2>
Video Writup: https://www.youtube.com/watch?v=1arJzf-zD_A <br>
challange link: https://play.picoctf.org/practice/challenge/216?category=6&page=1 <br>
points : 150

<b>Description</b>: Clutter, clutter everywhere and not a byte to use. 

```
#include <stdio.h>
#include <stdlib.h>

#define SIZE 0x100
#define GOAL 0xdeadbeef

const char* HEADER = 
" ______________________________________________________________________\n"
"|^ ^ ^ ^ ^ ^ |L L L L|^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^|\n"
"| ^ ^ ^ ^ ^ ^| L L L | ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ |\n"
"|^ ^ ^ ^ ^ ^ |L L L L|^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ==================^ ^ ^|\n"
"| ^ ^ ^ ^ ^ ^| L L L | ^ ^ ^ ^ ^ ^ ___ ^ ^ ^ ^ /                  \\^ ^ |\n"
"|^ ^_^ ^ ^ ^ =========^ ^ ^ ^ _ ^ /   \\ ^ _ ^ / |                | \\^ ^|\n"
"| ^/_\\^ ^ ^ /_________\\^ ^ ^ /_\\ | //  | /_\\ ^| |   ____  ____   | | ^ |\n"
"|^ =|= ^ =================^ ^=|=^|     |^=|=^ | |  {____}{____}  | |^ ^|\n"
"| ^ ^ ^ ^ |  =========  |^ ^ ^ ^ ^\\___/^ ^ ^ ^| |__%%%%%%%%%%%%__| | ^ |\n"
"|^ ^ ^ ^ ^| /     (   \\ | ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ |/  %%%%%%%%%%%%%%  \\|^ ^|\n"
".-----. ^ ||     )     ||^ ^.-------.-------.^|  %%%%%%%%%%%%%%%%  | ^ |\n"
"|     |^ ^|| o  ) (  o || ^ |       |       | | /||||||||||||||||\\ |^ ^|\n"
"| ___ | ^ || |  ( )) | ||^ ^| ______|_______|^| |||||||||||||||lc| | ^ |\n"
"|'.____'_^||/!\\@@@@@/!\\|| _'______________.'|==                    =====\n"
"|\\|______|===============|________________|/|\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\n"
"\" ||\"\"\"\"||\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"||\"\"\"\"\"\"\"\"\"\"\"\"\"\"||\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"  \n"
"\"\"''\"\"\"\"''\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"''\"\"\"\"\"\"\"\"\"\"\"\"\"\"''\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\n"
"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\n"
"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"\"";

int main(void)
{
  long code = 0;
  char clutter[SIZE];

  setbuf(stdout, NULL);
  setbuf(stdin, NULL);
  setbuf(stderr, NULL);
 	
  puts(HEADER); 
  puts("My room is so cluttered...");
  puts("What do you see?");

  gets(clutter);


  if (code == GOAL) {
    printf("code == 0x%llx: how did that happen??\n", GOAL);
    puts("take a flag for your troubles");
    system("cat flag.txt");
  } else {
    printf("code == 0x%llx\n", code);
    printf("code != 0x%llx :(\n", GOAL);
  }

  return 0;
}
```
From the very first look, we can see at line number 50 gets function is used, which is vulnerable for Buffer overflow vulnerability, so what program doing is
it declared global variable GOAL 0xdeadbeef ,and code = 0 in main function. first it will ask for the user input, whose size expected by program should be max. 
100 char. now there is an if condition which check code == GOAL ( which is false from the declartion of variables from the program), if it is true it will cat the
flag.txt, oterwise it will exit after printing code value.

![](1nd.png)

If we put 300 char long string as an input, the value of code variable get overwrite, so what we can do is we can try to overwrite the value of code variable in 
stack to 0xdeadbeef , so if condition become true and program will cat the flag.txt

![](3rd.png)

when we select option <b>c</b>, first it will call the fucntion <b>check_key</b> with <b>user input</b> and <b>SCHOFIELD trial_username</b> as an argument.
if the function written true then it will decrypt the license key otherwise it will exit.
```
def check_key(key, username_trial):

    global key_full_template_trial

    if len(key) != len(key_full_template_trial):
        return False
    else:
        # Check static base key part --v
        i = 0
        for c in key_part_static1_trial:
            if key[i] != c:
                return False

            i += 1

        # TODO : test performance on toolbox container
        # Check dynamic part --v
        if key[i] != hashlib.sha256(username_trial).hexdigest()[4]:
            return False
        else:
            i += 1

        if key[i] != hashlib.sha256(username_trial).hexdigest()[5]:
            return False
        else:
            i += 1

        if key[i] != hashlib.sha256(username_trial).hexdigest()[3]:
            return False
        else:
            i += 1

        if key[i] != hashlib.sha256(username_trial).hexdigest()[6]:
            return False
        else:
            i += 1

        if key[i] != hashlib.sha256(username_trial).hexdigest()[2]:
            return False
        else:
            i += 1

        if key[i] != hashlib.sha256(username_trial).hexdigest()[7]:
            return False
        else:
            i += 1

        if key[i] != hashlib.sha256(username_trial).hexdigest()[1]:
            return False
        else:
            i += 1

        if key[i] != hashlib.sha256(username_trial).hexdigest()[8]:
            return False



        return True
```
if we look function check_key closely we can find some conditions :)
  - length of our input should be equal to <b>key_full_template_trial<b> length (flag)
  - first part of our input should be equal to <b>key_part_static1_final</b> which is picoCTF{1n_7h3_|<3y_of_
<br>                                                                                                          
from above two points, it is clear we need to put the correct flag as a license key to get full version of aracane calculator.
                                                                                                              
![](4th.png)
<p>This part is for checking that whether the second part of user input (corresponding to dynamic part of flag), is equal to this values or not, so we can just
conculde each value using ipython3 and can predict the dynamic part</p>

 > ipython3
 
 > from cryptography.fernet import Fernet
   
 > import base64
   
 > username_trial = "SCHOFIELD"
    
 >  bUsername_trial = b"SCHOFIELD"
    
  
  ![](5th.png)
  
  <h3><b>Decrypting Dynamic Part</b></h3>
  <b>Note</b> in function check_key , 2nd argument is bUsername_trial, which is named as username_trial within the function, in ipython3 I am taking 
   bUsername_trial , so don't get confuse of it.
 
 
  ![](6th.png)
  <h3>So our final flag is <b>picoCTF{1n_7h3_|<3y_of_e584b363}</b></h3><br>
  I also write an script to automatically exploit this, check :)
  https://github.com/veer1024/CTFs/blob/main/PICOCTF/Reversing/keygenme-py/keygenme-trial-sol.py <br>
  <b> Thank You</b>
                                                                                                              
